<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>チーム自動振り分けツール</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #fffafc;
      color: #444;
      margin: 0;
      padding: 0;
    }
    header {
      background: linear-gradient(90deg, #ffb7c5, #ffe7a1, #b8e5c7);
      padding: 20px;
      text-align: center;
      font-size: 1.6em;
      font-weight: bold;
      color: #333;
      letter-spacing: 0.05em;
    }
    main {
      max-width: 900px;
      margin: 25px auto;
      background: #ffffffc9;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }
    .center { text-align: center; }
    button {
      background: #ffb7c5;
      border: none;
      border-radius: 8px;
      padding: 10px 25px;
      color: white;
      font-size: 1em;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover { background: #ff99ae; }
    .team-card {
      background: #f8fff6;
      border: 2px solid #b8e5c7;
      border-radius: 10px;
      padding: 10px 15px;
      margin-bottom: 20px;
    }
    .team-title {
      font-weight: bold;
      color: #4a8b65;
      margin-bottom: 5px;
      font-size: 1.1em;
    }
    ul { margin: 0; padding-left: 20px; }
    .member { margin: 2px 0; }
    .note {
      font-size: 0.9em;
      color: #666;
      text-align: center;
      margin-top: 10px;
    }
    .warn {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 10px 12px;
      border-radius: 10px;
      margin-top: 15px;
      font-size: 0.95em;
    }
  </style>
</head>
<body>
  <header>チーム自動振り分けツール</header>

  <main>
    <div class="center">
      <button id="fetchBtn">スプレッドシートから取得・振り分け</button>
    </div>

    <div id="resultArea" style="margin-top:25px;"></div>

    <div class="note">※スプレッドシートの更新内容が反映されるまで数秒かかる場合があります。</div>
  </main>

  <script>
    /* ================= 設定 ================= */
    // ★更新されたURLを反映
    const APPSCRIPT_URL = "https://script.google.com/macros/s/AKfycbw706v02H8g5OHpAamD4M0wnc3XKiBTWywx_f62M45KCPqSBE4dnahT-Iy2yWZAs88F9g/exec";
    const SHEET_ID = "1Q5mAiciojHktw4SYMcYTGgeRRWTgg-NDpigQOKVabFQ";
    const TEAM_SIZE = 4;

    // 4人チームで揃えたい職業（必要に応じて追加/変更OK）
    const ROLE_NEEDS = { "征服者": 1, "破壊者": 1, "守護者": 1, "掌握者": 1 };

    /* ================= 共通関数 ================= */
    function normalizeTarget(fixed, target) {
      const f = (fixed || "").trim();
      const t = (target || "").trim();

      // 除外
      if (f === "お休み" || t === "お休み") return null;
      // 「既チーム...」など、"既" で始まるものを除外（必要なら文言に合わせて調整）
      if (f.startsWith("既") || t.startsWith("既")) return null;

      // 固定目標優先
      if (f) return f;

      // 未入力なら64位
      if (!t) return "64位";

      return t;
    }

    function isFree(fixed, target) {
      return (fixed || "").trim() === "フリー枠"
          || (target || "").trim() === "フリー枠";
    }

    function teamState(team) {
      const roleCount = {};
      let total = 0;

      team.forEach(m => {
        total += m.skill;
        roleCount[m.role] = (roleCount[m.role] || 0) + 1;
      });

      let lackSum = 0;
      for (const r in ROLE_NEEDS) {
        lackSum += Math.max(0, ROLE_NEEDS[r] - (roleCount[r] || 0));
      }

      return { total, lackSum };
    }

    /* ===== フリー枠で「置換強化」：同職で弱い人を強いフリーに置換 ===== */
    function upgradeTeamsByFree(teams, free) {
      const freeByRole = {};
      free.forEach(p => {
        if (!freeByRole[p.role]) freeByRole[p.role] = [];
        freeByRole[p.role].push(p);
      });

      // 同職フリーは強い順
      for (const r in freeByRole) freeByRole[r].sort((a,b)=> b.skill - a.skill);

      // 各チームで、同職の最弱 < フリー最強 なら置換
      for (const team of teams) {
        for (const role in ROLE_NEEDS) {
          const pool = freeByRole[role];
          if (!pool || pool.length === 0) continue;

          const sameRole = team.map((m,i)=>({m,i})).filter(x => x.m.role === role);
          if (sameRole.length === 0) continue;

          sameRole.sort((a,b)=> a.m.skill - b.m.skill); // 弱い順
          const weakest = sameRole[0];
          const strongestFree = pool[0];

          if (strongestFree.skill > weakest.m.skill) {
            team[weakest.i] = strongestFree;
            pool.shift(); // 消費
          }
        }
      }
    }

    /* ===== チーム作成本体 ===== */
    function buildTeams(players) {
      // 目標ごとにまとめる（固定目標優先・未入力は64位）
      const byTarget = new Map();
      const free = [];

      players.forEach(p => {
        if (p.free) {
          free.push(p);
        } else {
          if (!byTarget.has(p.finalTarget)) byTarget.set(p.finalTarget, []);
          byTarget.get(p.finalTarget).push(p);
        }
      });

      const result = new Map();

      for (const [target, members] of byTarget.entries()) {
        // 戦力高い順
        members.sort((a,b)=> b.skill - a.skill);

        // チーム数
        const teamCount = Math.max(1, Math.ceil(members.length / TEAM_SIZE));
        const teams = Array.from({length: teamCount}, ()=>[]);

        // ① 通常メンバーを均等配分
        members.forEach((m,i)=>{
          teams[i % teamCount].push(m);
        });

        // ② フリー枠で不足補完（ロール不足優先＋戦力も加点）
        for (let i=0; i<free.length; i++) {
          const p = free[i];
          let bestIdx = -1;
          let bestScore = -Infinity;

          teams.forEach((t,idx)=>{
            if (t.length >= TEAM_SIZE) return;

            const before = teamState(t);
            const after = teamState(t.concat([p]));

            const score =
              (before.lackSum - after.lackSum) * 100 + // ロール不足改善が最優先
              (after.total - before.total);            // 戦力も加点

            if (score > bestScore) {
              bestScore = score;
              bestIdx = idx;
            }
          });

          if (bestIdx !== -1) {
            teams[bestIdx].push(p);
            free.splice(i,1);
            i--;
          }
        }

        // ③ フリー枠で置換強化（同職・高戦力を優先）
        upgradeTeamsByFree(teams, free);

        result.set(target, teams);
      }

      return { grouped: result, remainingFree: free };
    }

    /* ================= 実行 ================= */
    document.getElementById("fetchBtn").addEventListener("click", async () => {
      const btn = document.getElementById("fetchBtn");
      btn.disabled = true;
      btn.innerText = "取得中...";

      try {
        const url = `${APPSCRIPT_URL}?sheetId=${encodeURIComponent(SHEET_ID)}`;

        const res = await fetch(url, { cache: "no-store" });

        // 失敗時、原因が分かるようにエラーメッセージを出す
        if (!res.ok) {
          const text = await res.text().catch(()=> "");
          throw new Error(`HTTP ${res.status}: ${text.slice(0, 200)}`);
        }

        // JSONとして読めない（HTMLが返ってる等）もここで検知
        const data = await res.json();

        // シート列名：名前 / 職業 / 戦力 / 固定目標 / 目標順位 を想定
        const players = data.map(row => {
          const fixed = row["固定目標"];
          const target = row["目標順位"];

          return {
            name: (row["名前"] || "").trim(),
            role: (row["職業"] || "").trim(),
            skill: Number(row["戦力"]),
            finalTarget: normalizeTarget(fixed, target),
            free: isFree(fixed, target),
            _fixed: (fixed || "").trim(),
            _target: (target || "").trim(),
          };
        }).filter(p =>
          p.name && p.role && Number.isFinite(p.skill) && p.finalTarget !== null
        );

        const { grouped, remainingFree } = buildTeams(players);

        const resultArea = document.getElementById("resultArea");
        resultArea.innerHTML = "";

        // 目標ごとに表示
        for (const [target, teams] of grouped.entries()) {
          const h = document.createElement("div");
          h.style.margin = "20px 0 10px";
          h.style.fontWeight = "bold";
          h.textContent = `目標：${target}`;
          resultArea.appendChild(h);

          teams.forEach((team,i)=>{
            const div = document.createElement("div");
            div.className = "team-card";
            div.innerHTML = `
              <div class="team-title">チーム ${i+1}</div>
              <ul>
                ${team.map(m =>
                  `<li class="member">${m.name}（${m.role} / ${m.skill}）</li>`
                ).join("")}
              </ul>
            `;
            resultArea.appendChild(div);
          });
        }

        // 余ったフリー枠（使われなかった分）があれば表示
        if (remainingFree.length > 0) {
          const warn = document.createElement("div");
          warn.className = "warn";
          warn.innerHTML = `
            <b>未使用のフリー枠：</b><br>
            ${remainingFree.map(m => `${m.name}（${m.role} / ${m.skill}）`).join("<br>")}
          `;
          resultArea.appendChild(warn);
        }

      } catch (e) {
        alert("スプレッドシートの取得に失敗しました。GASの公開設定（全員アクセス可）とシート名・権限を確認してください。");
        console.error("Fetch error:", e);
      }

      btn.disabled = false;
      btn.innerText = "スプレッドシートから取得・振り分け";
    });
  </script>
</body>
</html>
