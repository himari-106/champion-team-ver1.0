<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>チーム自動振り分けツール</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #fffafc;
      color: #444;
      margin: 0;
      padding: 0;
    }
    header {
      background: linear-gradient(90deg, #ffb7c5, #ffe7a1, #b8e5c7);
      padding: 20px;
      text-align: center;
      font-size: 1.6em;
      font-weight: bold;
      color: #333;
    }
    main {
      max-width: 900px;
      margin: 25px auto;
      background: #ffffffc9;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }
    .center { text-align: center; }
    button {
      background: #ffb7c5;
      border: none;
      border-radius: 8px;
      padding: 10px 25px;
      color: white;
      font-size: 1em;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover { background: #ff99ae; }
    .team-card {
      background: #f8fff6;
      border: 2px solid #b8e5c7;
      border-radius: 10px;
      padding: 10px 15px;
      margin-bottom: 20px;
    }
    .team-title {
      font-weight: bold;
      color: #4a8b65;
      margin-bottom: 5px;
      font-size: 1.1em;
    }
    ul { margin: 0; padding-left: 20px; }
    .member { margin: 2px 0; }
    .note {
      font-size: 0.9em;
      color: #666;
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <header>チーム自動振り分けツール</header>
  <main>
    <div class="center">
      <button id="fetchBtn">スプレッドシートから取得・振り分け</button>
    </div>
    <div id="resultArea" style="margin-top:25px;"></div>
    <div class="note">※スプレッドシートの更新内容が反映されるまで数秒かかる場合があります。</div>
  </main>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // ✅ 新しいApps Script WebアプリURL
    const APPSCRIPT_URL = "https://script.google.com/macros/s/AKfycbwGe7K_GtbJJLAeS1QHIEtrhamOqUHf_LvX8i7YFbIxqREgjzZnRBz4ezZ04KR-OrJ3/exec";

    const TEAM_SIZE = 4;
    const ROLES = ["破壊者", "掌握者", "征服者", "守護者"];
    const FIXED_NONE = ["", "なし", "-", "無所属", null, undefined];

    // 並び順（1位→2位→…→フリー枠→空欄）
    const goalOrder = goal => {
      if (!goal || goal === "") return 999;
      if (goal.includes("フリー")) return 900;
      const num = parseInt(goal.replace(/\D/g, ""));
      return isNaN(num) ? 999 : num;
    };

    const makeTeam = (goal) => ({ members: [], power: 0, roles: new Set(), goal });
    const addMember = (team, member) => {
      team.members.push(member);
      team.power += member.power || 0;
      team.roles.add(member.job);
    };

    document.getElementById("fetchBtn").addEventListener("click", async () => {
      const btn = document.getElementById("fetchBtn");
      const resultArea = document.getElementById("resultArea");
      btn.disabled = true;
      btn.innerText = "取得中...";
      resultArea.innerHTML = "";

      try {
        const res = await fetch(`${APPSCRIPT_URL}?t=${Date.now()}`, { cache: "no-store" });
        const data = await res.json();

        const members = data
          .filter(d => d.name && d.job)
          .map((d, i) => ({
            id: `${d.name}_${i}`,
            name: d.name.trim(),
            job: d.job.trim(),
            power: Number(d.power) || 0,
            goal: d.goal ? d.goal.trim() : "",
            team: (d.team || "").trim()
          }));

        // 並べ替え（目標順位 → 戦力）
        members.sort((a, b) => {
          const rankDiff = goalOrder(a.goal) - goalOrder(b.goal);
          if (rankDiff !== 0) return rankDiff;
          return b.power - a.power;
        });

        const assignedIds = new Set();
        const goals = [...new Set(members.map(m => m.goal))].sort((a, b) => goalOrder(a) - goalOrder(b));
        const resultGroups = [];

        for (const goal of goals) {
          const sameGoal = members.filter(m => m.goal === goal);
          const fixedMap = new Map();
          const freeMembers = [];

          for (const m of sameGoal) {
            if (FIXED_NONE.includes(m.team)) {
              freeMembers.push(m);
            } else {
              if (!fixedMap.has(m.team)) fixedMap.set(m.team, []);
              fixedMap.get(m.team).push(m);
            }
          }

          const teams = [];

          // 固定チームを先に配置
          for (const group of fixedMap.values()) {
            const team = makeTeam(goal);
            group.forEach(m => {
              if (!assignedIds.has(m.id)) {
                addMember(team, m);
                assignedIds.add(m.id);
              }
            });
            teams.push(team);
          }

          // 残りを職業バランスで追加
          const available = freeMembers.filter(m => !assignedIds.has(m.id));
          const rolePools = {};
          ROLES.forEach(r => rolePools[r] = available.filter(m => m.job === r));

          while (Object.values(rolePools).some(arr => arr.length > 0)) {
            const team = makeTeam(goal);
            for (const role of ROLES) {
              if (team.members.length >= TEAM_SIZE) break;
              const candidate = rolePools[role].shift();
              if (candidate && !assignedIds.has(candidate.id)) {
                addMember(team, candidate);
                assignedIds.add(candidate.id);
              }
            }
            // 残枠を戦力順で埋める
            const remaining = available
              .filter(m => !assignedIds.has(m.id))
              .sort((a, b) => b.power - a.power);
            while (team.members.length < TEAM_SIZE && remaining.length > 0) {
              const next = remaining.shift();
              addMember(team, next);
              assignedIds.add(next.id);
            }
            if (team.members.length > 0) teams.push(team);
          }

          resultGroups.push({ goal, teams });
        }

        // 結果表示（1位→2位→3位→フリー→空欄）
        resultGroups
          .sort((a, b) => goalOrder(a.goal) - goalOrder(b.goal))
          .forEach(group => {
            const goalTitle = document.createElement("h3");
            goalTitle.textContent = `目標順位: ${group.goal || "（未選択）"}`;
            resultArea.appendChild(goalTitle);

            group.teams.forEach((team, i) => {
              const div = document.createElement("div");
              div.className = "team-card";
              div.innerHTML = `
                <div class="team-title">チーム ${i + 1}（${team.members.length}人）</div>
                <ul>
                  ${team.members.map(m => `
                    <li class="member">${m.name}（${m.job}）<br>
                    戦力: ${m.power} ／ 目標順位: ${m.goal || "未選択"}</li>
                  `).join("")}
                </ul>`;
              resultArea.appendChild(div);
            });
          });

      } catch (err) {
        alert("スプレッドシートの取得に失敗しました。");
        console.error(err);
      }

      btn.disabled = false;
      btn.innerText = "スプレッドシートから取得・振り分け";
    });
  });
  </script>
</body>
</html>
