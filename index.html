<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>チーム自動振り分けツール</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #fffafc;
      color: #444;
      margin: 0;
      padding: 0;
    }
    header {
      background: linear-gradient(90deg, #ffb7c5, #ffe7a1, #b8e5c7);
      padding: 20px;
      text-align: center;
      font-size: 1.6em;
      font-weight: bold;
      color: #333;
    }
    main {
      max-width: 900px;
      margin: 25px auto;
      background: #ffffffc9;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }
    .center { text-align: center; }
    button {
      background: #ffb7c5;
      border: none;
      border-radius: 8px;
      padding: 10px 25px;
      color: white;
      font-size: 1em;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover { background: #ff99ae; }
    .team-card {
      background: #f8fff6;
      border: 2px solid #b8e5c7;
      border-radius: 10px;
      padding: 10px 15px;
      margin-bottom: 20px;
    }
    .team-title {
      font-weight: bold;
      color: #4a8b65;
      margin-bottom: 5px;
      font-size: 1.1em;
    }
    ul { margin: 0; padding-left: 20px; }
    .member { margin: 2px 0; }
    .note {
      font-size: 0.9em;
      color: #666;
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <header>チーム自動振り分けツール</header>
  <main>
    <div class="center">
      <button id="fetchBtn">スプレッドシートから取得・振り分け</button>
    </div>
    <div id="resultArea" style="margin-top:25px;"></div>
    <div class="note">※スプレッドシートの更新内容が反映されるまで数秒かかる場合があります。</div>
  </main>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // ✅ 新しいApps Script URL
    const APPSCRIPT_URL = "https://script.google.com/macros/s/AKfycbx3KOAU2W6USgkUlzyOQy6z7dRz_lzss4wwNdZ6lqSnYwb77QwQweY-w2_qQR9KgM10/exec";
    const TEAM_SIZE = 4;
    const ROLES = ["破壊者", "掌握者", "征服者", "守護者"];
    const FIXED_NONE = ["", "なし", "-", "無所属"];

    function makeTeam(goal) {
      return { members: [], power: 0, roles: new Set(), goal };
    }
    function addMember(team, member) {
      team.members.push(member);
      team.power += member.power || 0;
      team.roles.add(member.job);
    }

    document.getElementById("fetchBtn").addEventListener("click", async () => {
      const btn = document.getElementById("fetchBtn");
      btn.disabled = true;
      btn.innerText = "取得中...";

      try {
        const res = await fetch(`${APPSCRIPT_URL}?t=${Date.now()}`);
        const text = await res.text();
        const data = JSON.parse(text);

        const members = data.filter(d => d.name && d.job && d.goal)
          .map(d => ({
            name: d.name.trim(),
            job: d.job.trim(),
            power: Number(d.power) || 0,
            goal: d.goal.trim(),
            team: d.team?.trim() || ""
          }));

        const goals = [...new Set(members.map(m => m.goal))];
        const resultGroups = [];

        for (const goal of goals) {
          const sameGoal = members.filter(m => m.goal === goal);
          const fixedMap = new Map();
          const freeMembers = [];

          for (const m of sameGoal) {
            if (FIXED_NONE.includes(m.team)) {
              freeMembers.push(m);
            } else {
              if (!fixedMap.has(m.team)) fixedMap.set(m.team, []);
              fixedMap.get(m.team).push(m);
            }
          }

          const teams = [];
          let current = makeTeam(goal);

          for (const group of fixedMap.values()) {
            if (current.members.length + group.length > TEAM_SIZE) {
              teams.push(current);
              current = makeTeam(goal);
            }
            for (const m of group) addMember(current, m);
          }

          const roleMap = {};
          for (const role of ROLES) {
            roleMap[role] = freeMembers.filter(m => m.job === role);
          }

          while (Object.values(roleMap).some(arr => arr.length > 0)) {
            if (current.members.length >= TEAM_SIZE) {
              teams.push(current);
              current = makeTeam(goal);
            }
            for (const role of ROLES) {
              if (current.members.length >= TEAM_SIZE) break;
              if (roleMap[role].length > 0 && !current.roles.has(role)) {
                addMember(current, roleMap[role].shift());
              }
            }
          }

          if (current.members.length > 0) teams.push(current);
          resultGroups.push({ goal, teams });
        }

        const resultArea = document.getElementById("resultArea");
        resultArea.innerHTML = "";
        resultGroups.forEach(group => {
          const goalTitle = document.createElement("h3");
          goalTitle.textContent = `目標順位: ${group.goal}`;
          resultArea.appendChild(goalTitle);

          group.teams.forEach((team, i) => {
            const div = document.createElement("div");
            div.className = "team-card";
            div.innerHTML = `
              <div class="team-title">チーム ${i + 1}</div>
              <ul>
                ${team.members.map(m => `
                  <li class="member">${m.name}（${m.job}）<br>
                  戦力: ${m.power} ／ 目標順位: ${m.goal}</li>
                `).join("")}
              </ul>`;
            resultArea.appendChild(div);
          });
        });
      } catch (err) {
        alert("スプレッドシートの取得に失敗しました。");
        console.error(err);
      }

      btn.disabled = false;
      btn.innerText = "スプレッドシートから取得・振り分け";
    });
  });
  </script>
</body>
</html>
