<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>チーム自動振り分け（診断）</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background:#fffafc; color:#333; }
    header { padding:16px 20px; font-weight:700; font-size:18px; background:linear-gradient(90deg,#ffb7c5,#ffe7a1,#b8e5c7); }
    main { max-width: 980px; margin: 18px auto; background:#fff; border-radius:14px; padding:18px; box-shadow:0 3px 10px rgba(0,0,0,.08); }
    button { background:#ffb7c5; border:none; border-radius:10px; padding:10px 16px; color:#fff; font-size:14px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .box { border-radius:12px; padding:12px; margin:12px 0; border:1px solid #ddd; background:#fafafa; white-space:pre-wrap; }
    .ok { border-color:#b7f5c7; background:#e6ffed; }
    .warn { border-color:#ffeeba; background:#fff3cd; }
    .err { border-color:#f5b7b7; background:#ffe6e6; }
    .team { border:2px solid #b8e5c7; background:#f8fff6; border-radius:12px; padding:12px; margin:10px 0; }
    .team h3 { margin:0 0 6px 0; color:#2f7a54; }
  </style>
</head>
<body>
<header>チーム自動振り分け（診断）</header>

<main>
  <div id="boot" class="box ok">✅ HTMLは描画できています（ここが出れば “真っ白＝HTML未配信” ではありません）</div>

  <div class="box">
    開いているURLは <b id="loc"></b> です。
    <br>※ 必ず <code>/index.html?v=任意</code> で開いてください（キャッシュ回避）。
  </div>

  <button id="fetchBtn">GASから取得テスト（JSONP）</button>
  <div id="log" class="box warn">ログがここに出ます</div>
  <div id="result"></div>
</main>

<script>
  // ========= ここだけ確認：あなたのGAS URL =========
  const APPSCRIPT_URL =
    "https://script.google.com/macros/s/AKfycbxAHyD_jBQ667q8P-GRilkvdP8MDE-KwBJ2lk6jE1PYfcGC4R8FbQUbD1L7DbYc-5M/exec";
  // =================================================

  document.getElementById("loc").textContent = location.href;

  // 画面にエラーを出す（白画面防止）
  const logEl = document.getElementById("log");
  function logBox(type, msg) {
    logEl.className = "box " + (type || "warn");
    logEl.textContent = msg;
  }
  window.addEventListener("error", (e) => {
    logBox("err", "❌ JSエラー\n" + (e.message || "") + "\n" + (e.filename || "") + ":" + (e.lineno || ""));
  });
  window.addEventListener("unhandledrejection", (e) => {
    logBox("err", "❌ Promiseエラー\n" + (e.reason ? String(e.reason) : ""));
  });

  // JSONP（CORS回避）
  function loadJsonp(url) {
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const script = document.createElement("script");
      const timer = setTimeout(() => {
        cleanup();
        reject(new Error("JSONP timeout"));
      }, 15000);

      function cleanup() {
        clearTimeout(timer);
        try { delete window[cbName]; } catch {}
        script.remove();
      }

      window[cbName] = (data) => { cleanup(); resolve(data); };
      script.onerror = () => { cleanup(); reject(new Error("JSONP load error")); };

      const sep = url.includes("?") ? "&" : "?";
      script.src = `${url}${sep}callback=${cbName}&_=${Date.now()}`;
      document.body.appendChild(script);
    });
  }

  // 取得テスト
  document.getElementById("fetchBtn").addEventListener("click", async () => {
    const btn = document.getElementById("fetchBtn");
    const result = document.getElementById("result");
    result.innerHTML = "";
    btn.disabled = true;
    btn.textContent = "取得中...";

    try {
      logBox("warn", "…JSONPでGASを呼び出しています\n" + APPSCRIPT_URL);

      const data = await loadJsonp(APPSCRIPT_URL);

      // GASが {ok:false,error:"..."} を返す設計ならここで表示
      if (data && data.ok === false) {
        logBox("err", "❌ GASエラー\n" + data.error);
        return;
      }

      if (!Array.isArray(data)) {
        logBox("err", "❌ 返ってきたデータが配列ではありません\n" + JSON.stringify(data, null, 2));
        return;
      }

      logBox("ok", `✅ 取得成功：${data.length}件\n先頭3件:\n` + JSON.stringify(data.slice(0,3), null, 2));

      // 表示（最低限）
      data.slice(0, 10).forEach((p, i) => {
        const div = document.createElement("div");
        div.className = "team";
        div.innerHTML = `<h3>Row ${i+1}</h3>
          ${String(p.name || "")} / ${String(p.job || "")} / ${String(p.power || "")} / 固定:${String(p.fixedGoal || "")} / 目標:${String(p.goal || "")}`;
        result.appendChild(div);
      });

    } catch (e) {
      logBox("err", "❌ 通信/取得エラー\n" + String(e));
    } finally {
      btn.disabled = false;
      btn.textContent = "GASから取得テスト（JSONP）";
    }
  });

  // 起動ログ
  logBox("ok",
    "✅ JS起動OK\n" +
    "1) ボタンを押す\n" +
    "2) ここに『取得成功』か『GASエラー/取得エラー』が出ます\n"
  );
</script>
</body>
</html>
