<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>チーム自動振り分けツール</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #fffafc;
      color: #444;
      margin: 0;
      padding: 0;
    }
    header {
      background: linear-gradient(90deg, #ffb7c5, #ffe7a1, #b8e5c7);
      padding: 20px;
      text-align: center;
      font-size: 1.6em;
      font-weight: bold;
      color: #333;
    }
    main {
      max-width: 900px;
      margin: 25px auto;
      background: #ffffffc9;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }
    .center { text-align: center; }
    button {
      background: #ffb7c5;
      border: none;
      border-radius: 8px;
      padding: 10px 25px;
      color: white;
      font-size: 1em;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover { background: #ff99ae; }
    .team-card {
      background: #f8fff6;
      border: 2px solid #b8e5c7;
      border-radius: 10px;
      padding: 10px 15px;
      margin-bottom: 20px;
    }
    .team-title {
      font-weight: bold;
      color: #4a8b65;
      margin-bottom: 5px;
      font-size: 1.1em;
    }
    ul { margin: 0; padding-left: 20px; }
    .member { margin: 2px 0; }
    .note {
      font-size: 0.9em;
      color: #666;
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <header>チーム自動振り分けツール</header>
  <main>
    <div class="center">
      <button id="fetchBtn">スプレッドシートから取得・振り分け</button>
    </div>
    <div id="resultArea" style="margin-top:25px;"></div>
    <div class="note">※スプレッドシートの更新内容が反映されるまで数秒かかる場合があります。</div>
  </main>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const APPSCRIPT_URL = "https://script.google.com/macros/s/AKfycbx3KOAU2W6USgkUlzyOQy6z7dRz_lzss4wwNdZ6lqSnYwb77QwQweY-w2_qQR9KgM10/exec";
    const TEAM_SIZE = 4;
    const ROLES = ["破壊者", "掌握者", "征服者", "守護者"];
    const FIXED_NONE = ["", "なし", "-", "無所属", null, undefined];

    const makeTeam = (goal) => ({ members: [], power: 0, roles: new Set(), goal });
    const addMember = (team, member) => {
      team.members.push(member);
      team.power += member.power || 0;
      team.roles.add(member.job);
    };

    document.getElementById("fetchBtn").addEventListener("click", async () => {
      const btn = document.getElementById("fetchBtn");
      const resultArea = document.getElementById("resultArea");
      btn.disabled = true;
      btn.innerText = "取得中...";
      resultArea.innerHTML = "";

      try {
        // 常に最新データを取得（キャッシュ防止）
        const res = await fetch(`${APPSCRIPT_URL}?t=${Date.now()}`, { cache: "no-store" });
        const data = await res.json();

        // データ整形
        const members = data
          .filter(d => d.name && d.job && d.goal)
          .map((d, i) => ({
            id: `${d.name}_${i}`, // 一意の識別子
            name: d.name.trim(),
            job: d.job.trim(),
            power: Number(d.power) || 0,
            goal: d.goal.trim(),
            team: (d.team || "").trim()
          }));

        // 並べ替え（目標順位昇順 → 職業順 → 戦力降順）
        members.sort((a, b) => {
          const rankA = parseInt(a.goal.replace(/\D/g, "")) || 9999;
          const rankB = parseInt(b.goal.replace(/\D/g, "")) || 9999;
          if (rankA !== rankB) return rankA - rankB;
          if (a.job !== b.job) return ROLES.indexOf(a.job) - ROLES.indexOf(b.job);
          return b.power - a.power;
        });

        const assignedIds = new Set();
        const goals = [...new Set(members.map(m => m.goal))];
        const resultGroups = [];

        for (const goal of goals) {
          const sameGoal = members.filter(m => m.goal === goal);
          const fixedMap = new Map();
          const freeMembers = [];

          // 固定チームと自由メンバー分け
          for (const m of sameGoal) {
            if (FIXED_NONE.includes(m.team)) {
              freeMembers.push(m);
            } else {
              if (!fixedMap.has(m.team)) fixedMap.set(m.team, []);
              fixedMap.get(m.team).push(m);
            }
          }

          const teams = [];

          // 固定チームを優先配置
          for (const group of fixedMap.values()) {
            const team = makeTeam(goal);
            group.forEach(m => {
              if (!assignedIds.has(m.id)) {
                addMember(team, m);
                assignedIds.add(m.id);
              }
            });
            teams.push(team);
          }

          // 残りメンバーを「職業バランス優先」で分配
          const available = freeMembers.filter(m => !assignedIds.has(m.id));
          const rolePools = {};
          ROLES.forEach(r => rolePools[r] = available.filter(m => m.job === r));

          while (Object.values(rolePools).some(arr => arr.length > 0)) {
            const team = makeTeam(goal);
            for (const role of ROLES) {
              if (team.members.length >= TEAM_SIZE) break;
              const candidate = rolePools[role].shift();
              if (candidate && !assignedIds.has(candidate.id)) {
                addMember(team, candidate);
                assignedIds.add(candidate.id);
              }
            }
            // 残った枠を戦力順で埋める
            const remaining = available
              .filter(m => !assignedIds.has(m.id))
              .sort((a, b) => b.power - a.power);
            while (team.members.length < TEAM_SIZE && remaining.length > 0) {
              const next = remaining.shift();
              addMember(team, next);
              assignedIds.add(next.id);
            }
            if (team.members.length > 0) teams.push(team);
          }

          resultGroups.push({ goal, teams });
        }

        // 結果表示
        resultGroups.forEach(group => {
          const goalTitle = document.createElement("h3");
          goalTitle.textContent = `目標順位: ${group.goal}`;
          resultArea.appendChild(goalTitle);

          group.teams.forEach((team, i) => {
            const div = document.createElement("div");
            div.className = "team-card";
            div.innerHTML = `
              <div class="team-title">チーム ${i + 1}（${team.members.length}人）</div>
              <ul>
                ${team.members.map(m => `
                  <li class="member">${m.name}（${m.job}）<br>
                  戦力: ${m.power} ／ 目標順位: ${m.goal}</li>
                `).join("")}
              </ul>`;
            resultArea.appendChild(div);
          });
        });

      } catch (err) {
        alert("スプレッドシートの取得に失敗しました。");
        console.error(err);
      }

      btn.disabled = false;
      btn.innerText = "スプレッドシートから取得・振り分け";
    });
  });
  </script>
</body>
</html>
