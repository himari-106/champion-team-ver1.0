<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>チーム自動振り分けツール</title>

  <style>
    body {
      font-family: "Segoe UI", system-ui, sans-serif;
      background: #fffafc;
      color: #444;
      margin: 0;
      padding: 0;
    }
    header {
      background: linear-gradient(90deg, #ffb7c5, #ffe7a1, #b8e5c7);
      padding: 20px;
      text-align: center;
      font-size: 1.6em;
      font-weight: bold;
      color: #333;
    }
    main {
      max-width: 900px;
      margin: 25px auto;
      background: #ffffff;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .center { text-align: center; }

    button {
      background: #ffb7c5;
      border: none;
      border-radius: 8px;
      padding: 10px 24px;
      color: white;
      font-size: 1em;
      cursor: pointer;
    }
    button:hover { background: #ff99ae; }

    .team-card {
      background: #f8fff6;
      border: 2px solid #b8e5c7;
      border-radius: 10px;
      padding: 12px 15px;
      margin-bottom: 16px;
    }
    .team-title {
      font-weight: bold;
      color: #4a8b65;
      margin-bottom: 6px;
    }
    ul { margin: 0; padding-left: 20px; }
    .member { margin: 2px 0; }

    .info {
      background: #e6ffed;
      border: 1px solid #b7f5c7;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 0.9em;
    }
    .warn {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 12px;
      border-radius: 8px;
      white-space: pre-wrap;
      margin-top: 15px;
    }
  </style>
</head>
<body>

<header>チーム自動振り分けツール</header>

<main>
  <div class="info">
    ✅ ページ読み込み成功（ここが見えていれば GitHub Pages は正常です）
  </div>

  <div class="center">
    <button id="fetchBtn">スプレッドシートから取得・振り分け</button>
  </div>

  <div id="resultArea" style="margin-top:25px;"></div>
</main>

<script>
/* ================= 設定 ================= */

// ★ あなたの最新 GAS URL
const APPSCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbxAHyD_jBQ667q8P-GRilkvdP8MDE-KwBJ2lk6jE1PYfcGC4R8FbQUbD1L7DbYc-5M/exec";

const TEAM_SIZE = 4;

// チームに最低1人ずつ欲しい職業
const ROLE_NEEDS = {
  "征服者": 1,
  "破壊者": 1,
  "守護者": 1,
  "掌握者": 1
};

/* ================= 共通処理 ================= */

function normalizeTarget(fixedGoal, goal) {
  const f = (fixedGoal || "").trim();
  const g = (goal || "").trim();

  if (f === "お休み" || g === "お休み") return null;
  if (f.startsWith("既") || g.startsWith("既")) return null;

  if (f) return f;
  if (!g) return "64位";
  return g;
}

function isFree(fixedGoal, goal) {
  return fixedGoal === "フリー枠" || goal === "フリー枠";
}

function teamState(team) {
  const roles = {};
  let power = 0;

  team.forEach(p => {
    power += p.skill;
    roles[p.role] = (roles[p.role] || 0) + 1;
  });

  let lack = 0;
  for (const r in ROLE_NEEDS) {
    lack += Math.max(0, ROLE_NEEDS[r] - (roles[r] || 0));
  }

  return { power, lack };
}

/* ===== フリー枠で同職・高戦力に置換 ===== */
function upgradeByFree(teams, free) {
  const byRole = {};
  free.forEach(p => (byRole[p.role] ??= []).push(p));
  for (const r in byRole) byRole[r].sort((a,b)=> b.skill - a.skill);

  for (const team of teams) {
    for (const role in ROLE_NEEDS) {
      if (!byRole[role]?.length) continue;

      const same = team.map((m,i)=>({m,i})).filter(x=>x.m.role===role);
      if (!same.length) continue;

      same.sort((a,b)=> a.m.skill - b.m.skill);
      if (byRole[role][0].skill > same[0].m.skill) {
        team[same[0].i] = byRole[role].shift();
      }
    }
  }

  return Object.values(byRole).flat();
}

/* ================= チーム生成 ================= */

function buildTeams(players) {
  const groups = new Map();
  let free = [];

  players.forEach(p => {
    if (p.free) free.push(p);
    else {
      if (!groups.has(p.target)) groups.set(p.target, []);
      groups.get(p.target).push(p);
    }
  });

  const result = new Map();

  for (const [target, members] of groups.entries()) {
    members.sort((a,b)=> b.skill - a.skill);
    const teamCount = Math.ceil(members.length / TEAM_SIZE);
    const teams = Array.from({length: teamCount}, ()=>[]);

    members.forEach((m,i)=> teams[i % teamCount].push(m));

    // フリー枠で不足補完
    for (let i=0; i<free.length; i++) {
      const p = free[i];
      let best = -1, score = -Infinity;

      teams.forEach((t,idx)=>{
        if (t.length >= TEAM_SIZE) return;
        const b = teamState(t);
        const a = teamState([...t,p]);
        const s = (b.lack - a.lack)*100 + (a.power - b.power);
        if (s > score) { score=s; best=idx; }
      });

      if (best !== -1) {
        teams[best].push(p);
        free.splice(i,1); i--;
      }
    }

    // 置換強化
    free = upgradeByFree(teams, free);

    result.set(target, teams);
  }

  return { result, free };
}

/* ================= 実行 ================= */

document.getElementById("fetchBtn").addEventListener("click", async () => {
  const area = document.getElementById("resultArea");
  area.innerHTML = "";

  try {
    const res = await fetch(APPSCRIPT_URL, { cache:"no-store" });
    const text = await res.text();
    let data;

    try { data = JSON.parse(text); }
    catch {
      area.innerHTML = `<div class="warn">❌ GASがJSONを返していません\n\n${text}</div>`;
      return;
    }

    if (!Array.isArray(data) || data.length === 0) {
      area.innerHTML = `<div class="warn">⚠ データが0件です</div>`;
      return;
    }

    const players = data.map(r => ({
      name: String(r.name||"").trim(),
      role: String(r.job||"").trim(),
      skill: Number(r.power)||0,
      target: normalizeTarget(r.fixedGoal, r.goal),
      free: isFree(r.fixedGoal, r.goal)
    })).filter(p=>p.name && p.role && p.target!==null);

    const { result, free } = buildTeams(players);

    for (const [target, teams] of result.entries()) {
      const h = document.createElement("h3");
      h.textContent = `目標：${target}`;
      area.appendChild(h);

      teams.forEach((t,i)=>{
        const d = document.createElement("div");
        d.className = "team-card";
        d.innerHTML = `<div class="team-title">チーム ${i+1}</div>
          <ul>${t.map(m=>`<li>${m.name}（${m.role} / ${m.skill}）</li>`).join("")}</ul>`;
        area.appendChild(d);
      });
    }

    if (free.length) {
      area.innerHTML += `<div class="warn">未使用フリー枠\n\n${free.map(m=>`${m.name}（${m.role} / ${m.skill}）`).join("\n")}</div>`;
    }

  } catch (e) {
    area.innerHTML = `<div class="warn">❌ 通信エラー\n\n${e}</div>`;
  }
});
</script>

</body>
</html>
